# Рефакторинг экрана "Настройки профиля" - Резюме

## Выполненные изменения

### Шаг 0: Обновление клавиатуры и текста экрана настроек ✅

**Изменения в `services/telegram_service.py`:**
- Удалены кнопки "Изменить норму" и "Уведомления"
- Переименованы оставшиеся кнопки:
  - "Изменить цель" (было "Изм...ть цель")
  - "Время отчёта" (было "Вре...тчетов")
  - "Сбросить профиль" (было "Сбр...рофиль")
  - "Изменить приём пищи" (было "Уда...данные")
- Обновлен текст экрана настроек с отображением времени отчетов

### Шаг 1: Реализация функции "Изменить цель" ✅

**Создана система состояний (`utils/user_states.py`):**
- `UserStateManager` для отслеживания диалогов
- Состояния: `GOAL_CHANGE_CURRENT_WEIGHT`, `GOAL_CHANGE_TARGET_WEIGHT`

**Многошаговый диалог:**
1. Пользователь вводит текущий вес
2. Пользователь вводит желаемый вес
3. Автоматический пересчет всех показателей (BMR, TDEE, дневные цели)
4. Сохранение в базу данных
5. Отображение обновленного главного меню

**Методы в `TelegramService`:**
- `_handle_settings_goal_callback()` - запуск диалога
- `_handle_goal_change_current_weight()` - обработка текущего веса
- `_handle_goal_change_target_weight()` - обработка целевого веса

### Шаг 2: Реализация функции "Время отчёта" ✅

**Обновлена модель данных:**
- Добавлено поле `daily_report_time` в `models/user_profile.py`
- Создана миграция `database/migration_add_daily_report_time.sql`

**Функциональность:**
- Запрос времени в формате ЧЧ:ММ
- Валидация формата времени
- Сохранение в московском времени (MSK)
- Состояние: `REPORT_TIME_INPUT`

**Методы:**
- `_handle_settings_reports_time_callback()` - запуск диалога
- `_handle_report_time_input()` - обработка ввода времени

### Шаг 3: Реализация функции "Сбросить профиль" ✅

**Функциональность:**
- Предупреждение с подтверждением
- Инлайн-кнопки "Да, сбросить" и "Отмена"
- Очистка всех полей профиля (кроме user_id и chat_id)
- Сохранение данных о еде и активности
- Автоматический запуск онбординга

**Методы:**
- `_handle_settings_reset_callback()` - показ предупреждения
- `_handle_settings_reset_confirm_callback()` - подтверждение сброса
- `_handle_settings_reset_cancel_callback()` - отмена

### Шаг 4: Реализация функции "Изменить приём пищи" ✅

**Сложная многоуровневая логика:**

**а. Отображение приёмов пищи:**
- Запрос записей за текущий день
- Формирование инлайн-клавиатуры с записями
- Callback data содержит log_id

**б. Обработка выбора:**
- Кнопки "Изменить" и "Удалить"
- Выбор поля для редактирования (калории, белки, жиры, углеводы)

**в. Логика удаления:**
- `DELETE FROM food_logs WHERE log_id = ...`
- Подтверждение успешного удаления

**г. Логика редактирования:**
- Многошаговый диалог для каждого поля
- Валидация введенных значений
- `UPDATE food_logs SET field = value WHERE log_id = ...`

**Новые методы в `HealthService`:**
- `get_food_logs_for_date()` - получение записей за день
- `get_food_log_by_id()` - получение записи по ID
- `update_food_log()` - обновление записи
- `delete_food_log()` - удаление записи

**Методы в `TelegramService`:**
- `_handle_settings_edit_food_callback()` - показ списка еды
- `_handle_food_edit_callback()` - выбор действия
- `_handle_food_action_callback()` - обработка действия
- `_handle_food_edit_field_callback()` - выбор поля для редактирования
- `_handle_food_delete_callback()` - удаление записи
- `_handle_food_edit_input()` - обработка ввода нового значения

## Технические детали

### Система состояний
- Простая in-memory система состояний
- Поддержка многошаговых диалогов
- Автоматическая очистка состояний

### Обработка callback'ов
- Добавлены новые обработчики в `_process_callback_query()`
- Поддержка сложных callback data с параметрами
- Обработка ошибок и валидация

### База данных
- Миграция выполнена успешно
- Новое поле `daily_report_time` добавлено
- Все CRUD операции для food_logs реализованы

### Валидация данных
- Проверка формата времени (ЧЧ:ММ)
- Валидация веса (1-500 кг)
- Проверка положительных значений для питательных веществ

## Структура файлов

```
services/
├── telegram_service.py     # Основная логика бота (обновлен)
└── health_service.py       # Работа с данными (дополнен)

models/
└── user_profile.py         # Модель пользователя (обновлена)

utils/
└── user_states.py          # Система состояний (новый файл)

database/
└── migration_add_daily_report_time.sql  # Миграция (новый файл)
```

## Готовность к использованию

✅ Все функции реализованы согласно требованиям  
✅ Система состояний работает корректно  
✅ База данных обновлена  
✅ Обработка ошибок реализована  
✅ Валидация данных настроена  
✅ Бот готов к тестированию  

## Следующие шаги

1. Протестировать все функции в реальном боте
2. Добавить дополнительные валидации при необходимости
3. Реализовать механизм расписания для ежедневных отчетов
4. Добавить логирование для отладки 